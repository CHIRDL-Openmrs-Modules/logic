<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqldiff PUBLIC "-//OpenMRS//DTD OpenMRS SQL Diff Config 1.0//EN" "http://resources.openmrs.org/doctype/sqldiff-1.0.dtd">

<sqldiff version="1.0">
	<diff>
		<version>1.0.0</version>
		<author>Nyoman Ribeka</author>
		<date>August 21, 2009</date>
		<description>
			New table to store token
		</description>
		<sql>
			DROP TABLE IF EXISTS logic_rule_token_tag;
			
			DROP TABLE IF EXISTS logic_rule_token;
			
			CREATE TABLE logic_rule_token (
			  logic_rule_token_id int(11) NOT NULL AUTO_INCREMENT,
			  creator int(11) NOT NULL,
			  date_created datetime NOT NULL default '0002-11-30 00:00:00',
			  changed_by int(11) default NULL,
			  date_changed datetime default NULL,
			  token varchar(512) NOT NULL,
			  class_name varchar(512) NOT NULL,
			  state varchar(512) default NULL,
			  PRIMARY KEY  (logic_rule_token_id),
			  CONSTRAINT token_creator FOREIGN KEY (creator) REFERENCES person (person_id),
			  CONSTRAINT token_changed_by FOREIGN KEY (changed_by) REFERENCES person (person_id)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE logic_rule_token_tag (
			  logic_rule_token_id int(11) NOT NULL,
			  tag varchar(512) NOT NULL,
			  CONSTRAINT token_tag FOREIGN KEY (logic_rule_token_id) REFERENCES logic_rule_token (logic_rule_token_id)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
		</sql>
	</diff>
	<diff>
		<version>1.1</version>
		<author>Michael Seaton</author>
		<date>September 24, 2010</date>
		<description>
			New table to store user-defined logic rules
		</description>
		<sql>					
			CREATE TABLE IF NOT EXISTS `logic_rule` (
			  `id` int(11) NOT NULL auto_increment,
			  `uuid` char(38) NOT NULL,
			  `name` varchar(255) NOT NULL unique,
			  `description` varchar(1000),
			  `rule_content` varchar(2048) NOT NULL,
			  `language` varchar(255) NOT NULL,
			  `creator` int(11) NOT NULL default '0',
			  `date_created` datetime NOT NULL default '0000-00-00 00:00:00',
			  `changed_by` int(11) default NULL,
  			  `date_changed` datetime default NULL,
			  `retired` tinyint(1) NOT NULL default '0',
			  `retired_by` int(11) default NULL,
  			  `date_retired` datetime default NULL,
  			  `retire_reason` varchar(255) default NULL,
			  PRIMARY KEY  (`id`),
			  KEY `creator for logic_rule` (`creator`),
			  KEY `changed_by for logic_rule` (`changed_by`),
			  KEY `retired_by for logic_rule` (`retired_by`),
			  CONSTRAINT `creator for logic_rule` FOREIGN KEY (`creator`) REFERENCES `users` (`user_id`),
			  CONSTRAINT `changed_by for logic_rule` FOREIGN KEY (`changed_by`) REFERENCES `users` (`user_id`),
			  CONSTRAINT `retired_by for logic_rule` FOREIGN KEY (`retired_by`) REFERENCES `users` (`user_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
		</sql>
	</diff>
	
	<diff>
		<version>1.3</version>
		<author>Nyoman Ribeka</author>
		<date>December 22, 2010</date>
		<description>
			Adding new uuid column to the logic_rule_token table
		</description>
		<sql>
			ALTER TABLE logic_rule_token ADD COLUMN uuid CHAR(38) DEFAULT NULL;
			UPDATE logic_rule_token SET uuid = UUID();
			ALTER TABLE logic_rule_token MODIFY COLUMN uuid CHAR(38) NOT NULL;
			CREATE UNIQUE INDEX logic_rule_token_uuid ON logic_rule_token (uuid);
		</sql>
	</diff>
	
	<diff>
		<version>1.4</version>
		<author>Darius Jazayeri</author>
		<date>December 30, 2010</date>
		<description>
			Creating logic_token_registration table (replacement for logic_rule_token)
		</description>
		<sql>
			CREATE TABLE logic_token_registration (
			  token_registration_id int(11) NOT NULL AUTO_INCREMENT,
			  creator int(11) NOT NULL,
			  date_created datetime NOT NULL default '0002-11-30 00:00:00',
			  changed_by int(11) default NULL,
			  date_changed datetime default NULL,
			  token varchar(512) NOT NULL,
			  provider_class_name varchar(512) NOT NULL,
			  provider_token varchar(512) NOT NULL,
			  configuration varchar(2000) default NULL,
			  uuid CHAR(38) NOT NULL,
			  PRIMARY KEY  (token_registration_id),
			  UNIQUE (uuid),
			  CONSTRAINT token_registration_creator FOREIGN KEY (creator) REFERENCES users (user_id),
			  CONSTRAINT token_registration_changed_by FOREIGN KEY (changed_by) REFERENCES users (user_id)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE logic_token_registration_tag (
			  token_registration_id int(11) NOT NULL,
			  tag varchar(512) NOT NULL,
			  CONSTRAINT token_registration_tag FOREIGN KEY (token_registration_id) REFERENCES logic_token_registration (token_registration_id)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
		</sql>
	</diff>
</sqldiff>
